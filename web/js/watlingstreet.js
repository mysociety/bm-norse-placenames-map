(function($, google, _, mySociety){

    var watlingStreetCoordinates = [
        [0.4483795166015625,51.46320536248151],
        [0.4350051976666691,51.45406607777215],
        [0.41236651934343627,51.4496305669131],
        [0.3832283023776881,51.44802436641731],
        [0.36247823840312776,51.44850177210327],
        [0.3420705862781688,51.450045393389864],
        [0.3304143162844184,51.45597335964909],
        [0.3245918536733825,51.46403994957246],
        [0.30977095242826636,51.470492040501654],
        [0.29803943775164043,51.465821141627956],
        [0.2804166601998759,51.45733118987793],
        [0.2561528667706625,51.46579977379993],
        [0.219276528621549,51.48400358106584],
        [0.20772060992817387,51.48603547796869],
        [0.1959930297144865,51.484004142379774],
        [0.18352319238567816,51.48656753126239],
        [0.17896034535192484,51.49102838632818],
        [0.1773150760536737,51.49634421748709],
        [0.1743815642798836,51.50144608645289],
        [0.1685289285305771,51.505479201766285],
        [0.14047983688305976,51.51321544267875],
        [0.12542303950249334,51.51606591895165],
        [0.11294131289957932,51.51271877797564],
        [0.10019921035450352,51.51245378767384],
        [0.08943211256973882,51.51026467765537],
        [0.08249127806379875,51.50460355519486],
        [0.07773424352558322,51.50003549090881],
        [0.06697034366538901,51.49706982498844],
        [0.04922065961454791,51.496800516204],
        [0.040044159053081785,51.497212705647726],
        [0.03189773422286635,51.49623495926969],
        [0.024008639817452604,51.49637876132373],
        [0.01629082830004336,51.49844568907708],
        [0.00806164838309087,51.50535674910654],
        [0.009629170502762463,51.50834410714245],
        [0.006561763482636707,51.50972881399592],
        [0.007602920018598525,51.51197021201888],
        [0.006927481636466837,51.514425276807735],
        [0.005302220985186068,51.514050309031326],
        [0.004535312155098836,51.512713865068704],
        [0.004369261046349493,51.51111030205004],
        [0.002658297204675364,51.510788750526594],
        [0.003990121773085775,51.51494689316707],
        [-0.002918243408203125,51.51803669675075],
        [-0.005196981539029366,51.516945521635684],
        [-0.006102438249854458,51.518311197429306],
        [-0.00877191783752096,51.52050826155808],
        [-0.007665123022661646,51.52345298044067],
        [-0.007931563894885585,51.52650450447938],
        [-0.011898523675199613,51.52961683630442],
        [-0.017401321335228204,51.5314399218486],
        [-0.017926208729249993,51.533690081116774],
        [-0.020993522290382316,51.53682892348828],
        [-0.020724946958807777,51.54074731872863],
        [-0.022688113447429714,51.544558941653094],
        [-0.030542492314225456,51.552224691343675],
        [-0.03887186846441182,51.55855729141175],
        [-0.04621323194328397,51.562470390449775],
        [-0.048233821433655066,51.56563629394358],
        [-0.05317341098520956,51.56853607706755],
        [-0.05828539738240579,51.57228924908485],
        [-0.06204361103436895,51.57973986262557],
        [-0.056360198864013,51.58409685087724],
        [-0.05659878753829162,51.58754739663394],
        [-0.05288883569278369,51.59270440187754],
        [-0.03531707849651866,51.613479265429184],
        [-0.028157226166854343,51.619495323356034],
        [-0.02202548641980684,51.626150491661654],
        [-0.015676798494041577,51.635257583489896],
        [-0.013016600307992121,51.640077429309734],
        [-0.012415972903227157,51.645429915767096],
        [-0.011986475464141222,51.65315281589534],
        [-0.00876764842951161,51.660368949422384],
        [-0.01213633676320569,51.66333815678757],
        [-0.013102095707267836,51.66726562390882],
        [-0.01402866929947777,51.67272385549613],
        [-0.012551925721368207,51.67679814471641],
        [-0.011504243129024871,51.68278852367227],
        [-0.010637009182119073,51.68519836766648],
        [-0.011486387823651967,51.68877890021811],
        [-0.01359660220589376,51.69698131013885],
        [-0.012788795459300673,51.70422611841821],
        [-0.005248309449257249,51.719674501058755],
        [-0.004572565646753901,51.736292745686214],
        [-0.0013622397857488977,51.74407188878336],
        [0.0011875158915017892,51.745198064619586],
        [0.002879319922385548,51.75163833688837],
        [0.002545062133549436,51.75440669904249],
        [0.005729985328116527,51.75552793459702],
        [0.010245472707879344,51.75555997685306],
        [0.012958682342969041,51.75761085301095],
        [0.013376070037452337,51.758851623679696],
        [0.01208273135807758,51.76085327982217],
        [0.012591810673598047,51.76189868876157],
        [0.013352456561733561,51.76462694348634],
        [0.012531130879892771,51.76580515276478],
        [0.011108943704016383,51.766505282122715],
        [0.01026925554231184,51.76734671954676],
        [0.009086222197424831,51.76781632682945],
        [0.008632729116698101,51.768578065705945],
        [0.007664233764899109,51.76896799171827],
        [0.006156331253578173,51.770146195652664],
        [0.004820007507532864,51.77158994981865],
        [0.0042698826596279105,51.7728893905424],
        [0.002861397991296144,51.774029492005255],
        [0.002104288890564021,51.77588481780976],
        [0.0030423579200942186,51.77681078940445],
        [0.003894642481327537,51.7782147043536],
        [0.0053904011447230005,51.77982428727126],
        [0.006027900941376174,51.78116838120238],
        [0.004884430791435079,51.782804539192085],
        [0.004427535866170729,51.78513097167738],
        [0.003535375883075176,51.78748752455878],
        [0.0013556113592585461,51.789366217837284],
        [0.002529312566707631,51.7905975295736],
        [0.0021580899019681965,51.792572089693806],
        [1.2807207838250179E-4,51.79551252215283],
        [-0.00102648850611331,51.797467063525744],
        [-0.003125316194541483,51.799103093490544],
        [-0.005220211991627366,51.79873914246463],
        [-0.007111942064852883,51.7994642437758],
        [-0.007673330922443711,51.800534343847765],
        [-0.009479296928248004,51.80072864280749],
        [-0.010341150990484493,51.801400623454796],
        [-0.011678718820803624,51.80324877730166],
        [-0.014046371909444133,51.804247704539996],
        [-0.016124409858434774,51.804722534286476],
        [-0.017086713096659878,51.806152650826554],
        [-0.019679860020119122,51.807423517092005],
        [-0.019698143005371094,51.80811060054217],
        [-0.021025957829920117,51.80861506656059],
        [-0.02218215955144842,51.80986247229504],
        [-0.023037960677811498,51.8092790320487],
        [-0.024237062796828468,51.80890785257525],
        [-0.02877613245414068,51.80959879394746],
        [-0.03488171863955358,51.810435444243666],
        [-0.03824073688178942,51.809732973626254],
        [-0.042136096521517175,51.8111264206233],
        [-0.04809144785428998,51.81023782427805],
        [-0.05057550923254439,51.80945516330002],
        [-0.05280203556765173,51.80941539422465],
        [-0.0573407396402672,51.8071068254453],
        [-0.06357454481360492,51.807133107783116],
        [-0.06714720647903505,51.803736080141455],
        [-0.07334769892463555,51.80124046879577],
        [-0.08044817760901424,51.79635578636232],
        [-0.08485618802399131,51.794842209995686],
        [-0.08920585264706915,51.79429770834223],
        [-0.08823394775390625,51.79287726155389],
        [-0.08651728675306458,51.79044840975155],
        [-0.08746147155761719,51.78836465754666],
        [-0.08750958800533226,51.785844469863385],
        [-0.09133411319726292,51.78526216823183],
        [-0.09443393448930237,51.78399131060492],
        [-0.10097584493519207,51.78304276345422],
        [-0.1102806897647497,51.777322357066964],
        [-0.11913748052393203,51.77217794518995],
        [-0.12270330596481926,51.7700285740491],
        [-0.12626900997724988,51.77064096490009],
        [-0.12912669125091725,51.77182421819602],
        [-0.1310832733324787,51.77340573030895],
        [-0.13443816073322523,51.77388657126119],
        [-0.13594395301151962,51.77295854064025],
        [-0.13813637132602707,51.77341133686034],
        [-0.13936320144216552,51.77426241990255],
        [-0.14092076685335542,51.77505970386743],
        [-0.14153418322609923,51.77378575088806],
        [-0.14501784240701454,51.773628970184575],
        [-0.1474651586283926,51.773643812728245],
        [-0.1494832729523523,51.77264952797597],
        [-0.15317615425294662,51.772466608328116],
        [-0.16056188393690718,51.77289706075222],
        [-0.16369707997716887,51.774147751032004],
        [-0.16811985547769837,51.77412370469866],
        [-0.17554931387667239,51.77436734320432],
        [-0.17945745401664226,51.77365249084035],
        [-0.18306506679277845,51.772592308187456],
        [-0.18697300426379115,51.77275354699287],
        [-0.19053757531912652,51.77206489556064],
        [-0.19476749641808055,51.77081842413924],
        [-0.19968385884772033,51.77004978890575],
        [-0.20314128371637707,51.77132581925685],
        [-0.2044409630273094,51.77361024020685],
        [-0.20634159278699826,51.77515110365606],
        [-0.2095099611369733,51.776984541471485],
        [-0.21285016721344618,51.777596454477035],
        [-0.2153322460505933,51.778819033524975],
        [-0.21798612953534757,51.780121217558644],
        [-0.22328115381048974,51.78705551964103],
        [-0.22558614683202904,51.79050901149431],
        [-0.22960817848820625,51.79311298100352],
        [-0.22981691945892635,51.796538258591646],
        [-0.23448905459656544,51.79677847981089],
        [-0.24040049669827113,51.79810808411023],
        [-0.24170347947892878,51.801551624178394],
        [-0.2447232636912986,51.802022786499506],
        [-0.25007681634474466,51.80572498595009],
        [-0.25714785110801586,51.81038207994759],
        [-0.26284646317367333,51.81185480024451],
        [-0.27360973033285063,51.81338021766606],
        [-0.2802533289616349,51.812464333603884],
        [-0.2868970593553968,51.81467864695651],
        [-0.2904510498046875,51.81392126719709],
        [-0.3043427648386796,51.81516057645839],
        [-0.31060225147314213,51.817265318915574],
        [-0.3165185825913568,51.816398444996864],
        [-0.32337948629356106,51.81823729235324],
        [-0.33058412107595814,51.81901457508724],
        [-0.3398451544397858,51.824176205046854],
        [-0.37825584411621094,51.85491955077784],
        [-0.41748046875,51.88115370126789],
        [-0.46636503660147355,52.13461928930519],
        [-0.4696616014630308,52.134249155534285],
        [-0.47261468077874724,52.13229840434162],
        [-0.4773186982903326,52.12913428034981],
        [-0.4860400823600912,52.128654126967774],
        [-0.5010795593261719,52.130642963848],
        [-0.5028369713550092,52.12590669799645],
        [-0.5013327770872138,52.121275724841155],
        [-0.5041605241178786,52.11896977995481],
        [-0.5118748740021601,52.11773061347627],
        [-0.5170193848891813,52.12048317319786],
        [-0.5177012113676938,52.12555444442966],
        [-0.5224994709349176,52.133588813679324],
        [-0.5260877283232048,52.14206817466957],
        [-0.5217018686164465,52.146729227106725],
        [-0.5155985205587967,52.14949393314565],
        [-0.5021714710769629,52.15096718389537],
        [-0.4978701756256214,52.148438680029706],
        [-0.4911659074596173,52.14864857472469],
        [-0.4868646234317566,52.15096487823708],
        [-0.485309547474003,52.1543343881496],
        [-0.4903967964144158,52.15841588123046],
        [-0.49960499241353773,52.161022577709545],
        [-0.5156196687053125,52.16202218882334],
        [-0.5292065821585084,52.16510261145694],
        [-0.541765522480091,52.168813357241476],
        [-0.5592887860092333,52.178143236462276],
        [-0.5637557676712959,52.18179128657097],
        [-0.5603264135659174,52.1856498452947],
        [-0.5570664780466359,52.18584248860781],
        [-0.5534632387802958,52.18540355424346],
        [-0.5466004324619007,52.1832623984774],
        [-0.5393967234972479,52.1842958369696],
        [-0.532879860826597,52.18196082527809],
        [-0.5265349502976733,52.17930955856545],
        [-0.5201904058540094,52.179394706961865],
        [-0.5124493145389124,52.18163241756118],
        [-0.5122605869531753,52.18765912860096],
        [-0.5179089727291739,52.191580798924036],
        [-0.5280209744601052,52.19002969118964],
        [-0.5351992775523513,52.191874207464316],
        [-0.5384454336135605,52.19426957293832],
        [-0.5392885701139676,52.197085806214645],
        [-0.5376942710428239,52.20101919068791],
        [-0.5326662210343329,52.20411079805667],
        [-0.530323612657412,52.20428880112449],
        [-0.5276378161435105,52.2017314484714],
        [-0.5215797216596911,52.20187680417727],
        [-0.5164651840045735,52.20323220696586],
        [-0.5134102176548367,52.205849917563725],
        [-0.5131015628875275,52.209309196768345],
        [-0.515539655953944,52.21276846639179],
        [-0.5178415644950292,52.217740844305496],
        [-0.5259808320195134,52.22018886486443],
        [-0.5353222126583432,52.22053304237487],
        [-0.5403360756000666,52.220179081134276],
        [-0.5419164554514282,52.21709070396153],
        [-0.5479650330328241,52.21260774930562],
        [-0.5525337840714428,52.21005048541664],
        [-0.5581322310384849,52.210227866550966],
        [-0.5662388024993561,52.20995113836646],
        [-0.5746885934798911,52.20967383099951],
        [-0.5867423405170484,52.20923824366641],
        [-0.5908983922972766,52.202700837028175],
        [-0.5981434088861306,52.19847684056675],
        [-0.6074477684285284,52.199512913422495],
        [-0.6151182407702436,52.19630035581744],
        [-0.6189530252943314,52.194904379609184],
        [-0.6217575073242188,52.191824701804904],
        [-0.6232481925316051,52.18548293460618],
        [-0.628857771746425,52.17956204719646],
        [-0.6306026928888286,52.17257390835996],
        [-0.635093334582848,52.16727010953795],
        [-0.6292837824641992,52.15943924449787],
        [-0.6315289881887338,52.156155647459],
        [-0.635833740234375,52.15413574555202],
        [-0.6403820776738485,52.153891189715004],
        [-0.6449304942534582,52.15491030905785],
        [-0.6505947664529685,52.1586333001407],
        [-0.6569462373480519,52.162144890405614],
        [-0.6608088800373935,52.16158378002497],
        [-0.6674178736002432,52.16018000674497],
        [-0.6780612486912787,52.162634476219075],
        [-0.6900787353515625,52.16340302979992],
        [-0.6924788679380072,52.15617421443653],
        [-0.6909321378414006,52.15234916606609],
        [-0.6928186060940789,52.1485241174516],
        [-0.7104943162717063,52.14796025731475],
        [-0.7213019973197561,52.14360251885455],
        [-0.7300471152329919,52.134818310850754],
        [-0.735448441220683,52.1314794435336],
        [-0.74153587773867,52.13066925177964],
        [-0.7474861371431416,52.128826168074326],
        [-0.7534357354276153,52.125718205403],
        [-0.7585267401602778,52.12366374615672],
        [-0.7622437145744243,52.11823648017634],
        [-0.7569753104696701,52.113284502996805],
        [-0.7489613600930625,52.111283797632],
        [-0.729953131454181,52.11087128733324],
        [-0.7084257181526254,52.09570805516867],
        [-0.7095036617708956,52.09107844221944],
        [-0.7147009756176885,52.08855812372316],
        [-0.7267640965209239,52.09531831305269],
        [-0.7317669950959953,52.10038501553005],
        [-0.7408905029296875,52.09996782449456],
        [-0.7605484574380625,52.093842470542675],
        [-0.7628081175030275,52.08721740885789],
        [-0.7588871952116278,52.077638334366895],
        [-0.7681819910887953,52.07618267191483],
        [-0.7783223959287398,52.080307458472234],
        [-0.7850297760826379,52.07725765600448],
        [-0.7869408713132771,52.070551440181575],
        [-0.8005236380774932,52.06975356540953],
        [-0.8335187510047035,52.063721941454055],
        [-0.8686065673828125,52.0664223983707],
        [-0.9248573945027374,52.097865562837875],
        [-0.990142822265625,52.133488040771496],
        [-1.2035392307597021,52.3977446963365],
        [-1.270579573663781,52.46418789750692],
        [-1.311492919921875,52.49657756892352],
        [-1.3652943482344426,52.51635568764623],
        [-1.5938107655216527,52.59118997429581],
        [-1.8532562255859375,52.65431131840966],
        [-2.001161768240081,52.66709271063439],
        [-2.135467529296875,52.69552880253609],
        [-2.395434272605371,52.69439629516566],
        [-2.5881385803222656,52.69095100233819],
        [-2.6077938079833984,52.68528010703772],
        [-2.6262474060058594,52.68127361783348],
        [-2.6456451416015625,52.67107362312944]
    ];

    // Create a Path suitable for creating a google.maps.Polyline from an
    // array of coordinates in the Lon,Lat format Google's KML exports them
    var createWatlingStreetPath = function(coordinates) {
        var path = [];
        _.each(coordinates, function(coordinate) {
            path.push(new google.maps.LatLng(coordinate[1], coordinate[0]));
        });
        return path;
    };

    $(function() {
        var $map = $('#map-canvas');
        // Create watling street
        var watlingStreet = new google.maps.Polyline({
            path: createWatlingStreetPath(watlingStreetCoordinates),
            geodesic: true,
            strokeColor: '#4A5561',
            strokeOpacity: 1,
            strokeWeight: 3,
            zIndex: 2
        });
        var watlingStreetShadow = new google.maps.Polyline({
            path: createWatlingStreetPath(watlingStreetCoordinates),
            geodesic: true,
            strokeColor: '#3F482D',
            strokeOpacity: 0.2,
            strokeWeight: 9,
            zIndex: 1
        });
        var markerInfoTemplate = _.template($('script#watlingStreetMarkerInfo').html());
        var markerInfo = markerInfoTemplate();
        // Create an infowindow to show details in
        var infoWindow = new google.maps.InfoWindow({
            content: markerInfo,
            maxWidth: Math.round($map.innerWidth() * 0.65)
        });
        google.maps.event.addListener(watlingStreet, 'click', function(e) {
            infoWindow.setPosition(e.latLng);
            infoWindow.open(mySociety.map);
        });

        // Export Watling Street
        mySociety.watlingStreet = watlingStreet;
        mySociety.watlingStreetShadow = watlingStreetShadow;
    });

})(window.jQuery, window.google, window._, window.mySociety);
